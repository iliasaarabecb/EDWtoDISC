<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The EDWtoDISC package is used to initialize and maintain the EDW Data Production Pipeline 2021 which pushes deal submissions stored in EDW's database to a Parquet optimized table within DISC, leveraging HDFS and queryable through Imapala."><meta name=author content="Ilias Aarab"><link href=https://gitlab.sofa.dev/Ilias.Aarab/EDWtoDISC/docstrings/UpdateDeals/ rel=canonical><link rel=icon href=../../assets/favicon.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-7.1.8"><title>UpdateDeals - EDWtoDISC</title><link rel=stylesheet href=../../assets/stylesheets/main.ca7ac06f.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.f1a3b89f.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/_mkdocstrings.css></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script> <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#src.EDWtoDISC._UpdateDeals class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title=EDWtoDISC class="md-header__button md-logo" aria-label=EDWtoDISC data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"> <path d=M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z /> <path d=M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z style="fill-opacity: 0.5"/> <path d=M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z /> <path d=M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z style="fill-opacity: 0.25"/> </svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> EDWtoDISC </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> UpdateDeals </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7 10a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2m10-3a5 5 0 0 1 5 5 5 5 0 0 1-5 5H7a5 5 0 0 1-5-5 5 5 0 0 1 5-5h10M7 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3h10a3 3 0 0 0 3-3 3 3 0 0 0-3-3H7z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=red data-md-color-accent=red aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg> </label> </form> <div class=md-header__source> <a href=https://gitlab.sofa.dev/Ilias.Aarab/EDWtoDISC title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> Gitlab/EDWtoDISC </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../getting-started/ class=md-tabs__link> Getting started </a> </li> <li class=md-tabs__item> <a href=../PDP/ class="md-tabs__link md-tabs__link--active"> Code Reference </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title=EDWtoDISC class="md-nav__button md-logo" aria-label=EDWtoDISC data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"> <path d=M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z /> <path d=M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z style="fill-opacity: 0.5"/> <path d=M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z /> <path d=M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z style="fill-opacity: 0.25"/> </svg> </a> EDWtoDISC </label> <div class=md-nav__source> <a href=https://gitlab.sofa.dev/Ilias.Aarab/EDWtoDISC title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> Gitlab/EDWtoDISC </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Getting started <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Getting started" data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Getting started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../getting-started/ class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../command-line-tool/ class=md-nav__link> Command Line Tool </a> </li> <li class=md-nav__item> <a href=../../jupyter-notebook/ class=md-nav__link> Jupyter Notebook </a> </li> <li class=md-nav__item> <a href=../../ide/ class=md-nav__link> IDE </a> </li> <li class=md-nav__item> <a href=../../troubleshooting/ class=md-nav__link> Troubleshooting </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3> Code Reference <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Code Reference" data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Code Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../PDP/ class=md-nav__link> PDP </a> </li> <li class=md-nav__item> <a href=../CreateBackups/ class=md-nav__link> CreateBackups </a> </li> <li class=md-nav__item> <a href=../CreateDictionaries/ class=md-nav__link> CreateDictionaries </a> </li> <li class=md-nav__item> <a href=../CreateTables/ class=md-nav__link> CreateTables </a> </li> <li class=md-nav__item> <a href=../EDWSubmissionTracker/ class=md-nav__link> EDWSubmissionTracker </a> </li> <li class=md-nav__item> <a href=../InitializeClients/ class=md-nav__link> InitializeClients </a> </li> <li class=md-nav__item> <a href=../InitializeProxyServer/ class=md-nav__link> InitializeProxyServer </a> </li> <li class=md-nav__item> <a href=../Preprocesser/ class=md-nav__link> Preprocesser </a> </li> <li class=md-nav__item> <a href=../ToDISC/ class=md-nav__link> ToDISC </a> </li> <li class=md-nav__item> <a href=../ToNameSpace/ class=md-nav__link> ToNameSpace </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> UpdateDeals <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> UpdateDeals </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#src.EDWtoDISC._UpdateDeals class=md-nav__link> src.EDWtoDISC._UpdateDeals </a> </li> <li class=md-nav__item> <a href=#src.EDWtoDISC._UpdateDeals.UpdateDeals class=md-nav__link> UpdateDeals </a> <nav class=md-nav aria-label=UpdateDeals> <ul class=md-nav__list> <li class=md-nav__item> <a href=#src.EDWtoDISC._UpdateDeals.UpdateDeals.update_deals class=md-nav__link> update_deals() </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#src.EDWtoDISC._UpdateDeals class=md-nav__link> src.EDWtoDISC._UpdateDeals </a> </li> <li class=md-nav__item> <a href=#src.EDWtoDISC._UpdateDeals.UpdateDeals class=md-nav__link> UpdateDeals </a> <nav class=md-nav aria-label=UpdateDeals> <ul class=md-nav__list> <li class=md-nav__item> <a href=#src.EDWtoDISC._UpdateDeals.UpdateDeals.update_deals class=md-nav__link> update_deals() </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>UpdateDeals</h1> <div class="doc doc-object doc-module"> <a id=src.EDWtoDISC._UpdateDeals></a> <div class="doc doc-contents first"> <p><a class="magiclink magiclink-github magiclink-mention" href=https://github.com/author title="GitHub User: author">@author</a>: aarabil / Aarab Ilias </p> <p>ESRB | Beyond Banking Team | Securitisation Monitor | EDW Data Production Pipeline 2021</p> <p>Helper functions and classes to download the lastest deal submission from EDW's database: </p> <p>This module implements various auxiliary functions/classes which are used to keep track of deal submissions (across different PCD's) that have been processed through the various stages of the Pipeline (1, 2A, 2B, 3A and 4A). Allows to determine the recent submissions that haven't gone through the Pipeline and downloads them from the EDW database to store within a local environment (Pipeline 1)</p> <p>Including: * Download module to store latest deals within a local environment * Creation of a csv file which keeps track of the deals (and related PCD's) throughout the various stages of the Pipeline. Sets the starting point for Pipeline 1</p> <p>Prerequisite: * User needs EDWIN account with the European Data Warehouse</p> <div class="doc doc-children"> <div class="doc doc-object doc-class"> <h2 id=src.EDWtoDISC._UpdateDeals.UpdateDeals class="doc doc-heading"> <code>UpdateDeals</code> <a href=#src.EDWtoDISC._UpdateDeals.UpdateDeals class=headerlink title="Permanent link">&para;</a></h2> <div class="doc doc-contents "> <details class=quote> <summary>Source code in <code>src\EDWtoDISC\_UpdateDeals.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 38</span>
<span class=normal> 39</span>
<span class=normal> 40</span>
<span class=normal> 41</span>
<span class=normal> 42</span>
<span class=normal> 43</span>
<span class=normal> 44</span>
<span class=normal> 45</span>
<span class=normal> 46</span>
<span class=normal> 47</span>
<span class=normal> 48</span>
<span class=normal> 49</span>
<span class=normal> 50</span>
<span class=normal> 51</span>
<span class=normal> 52</span>
<span class=normal> 53</span>
<span class=normal> 54</span>
<span class=normal> 55</span>
<span class=normal> 56</span>
<span class=normal> 57</span>
<span class=normal> 58</span>
<span class=normal> 59</span>
<span class=normal> 60</span>
<span class=normal> 61</span>
<span class=normal> 62</span>
<span class=normal> 63</span>
<span class=normal> 64</span>
<span class=normal> 65</span>
<span class=normal> 66</span>
<span class=normal> 67</span>
<span class=normal> 68</span>
<span class=normal> 69</span>
<span class=normal> 70</span>
<span class=normal> 71</span>
<span class=normal> 72</span>
<span class=normal> 73</span>
<span class=normal> 74</span>
<span class=normal> 75</span>
<span class=normal> 76</span>
<span class=normal> 77</span>
<span class=normal> 78</span>
<span class=normal> 79</span>
<span class=normal> 80</span>
<span class=normal> 81</span>
<span class=normal> 82</span>
<span class=normal> 83</span>
<span class=normal> 84</span>
<span class=normal> 85</span>
<span class=normal> 86</span>
<span class=normal> 87</span>
<span class=normal> 88</span>
<span class=normal> 89</span>
<span class=normal> 90</span>
<span class=normal> 91</span>
<span class=normal> 92</span>
<span class=normal> 93</span>
<span class=normal> 94</span>
<span class=normal> 95</span>
<span class=normal> 96</span>
<span class=normal> 97</span>
<span class=normal> 98</span>
<span class=normal> 99</span>
<span class=normal>100</span>
<span class=normal>101</span>
<span class=normal>102</span>
<span class=normal>103</span>
<span class=normal>104</span>
<span class=normal>105</span>
<span class=normal>106</span>
<span class=normal>107</span>
<span class=normal>108</span>
<span class=normal>109</span>
<span class=normal>110</span>
<span class=normal>111</span>
<span class=normal>112</span>
<span class=normal>113</span>
<span class=normal>114</span>
<span class=normal>115</span>
<span class=normal>116</span>
<span class=normal>117</span>
<span class=normal>118</span>
<span class=normal>119</span>
<span class=normal>120</span>
<span class=normal>121</span>
<span class=normal>122</span>
<span class=normal>123</span>
<span class=normal>124</span>
<span class=normal>125</span>
<span class=normal>126</span>
<span class=normal>127</span>
<span class=normal>128</span>
<span class=normal>129</span>
<span class=normal>130</span>
<span class=normal>131</span>
<span class=normal>132</span>
<span class=normal>133</span>
<span class=normal>134</span>
<span class=normal>135</span>
<span class=normal>136</span>
<span class=normal>137</span>
<span class=normal>138</span>
<span class=normal>139</span>
<span class=normal>140</span>
<span class=normal>141</span>
<span class=normal>142</span>
<span class=normal>143</span>
<span class=normal>144</span>
<span class=normal>145</span>
<span class=normal>146</span>
<span class=normal>147</span>
<span class=normal>148</span>
<span class=normal>149</span>
<span class=normal>150</span>
<span class=normal>151</span>
<span class=normal>152</span>
<span class=normal>153</span>
<span class=normal>154</span>
<span class=normal>155</span>
<span class=normal>156</span>
<span class=normal>157</span>
<span class=normal>158</span>
<span class=normal>159</span>
<span class=normal>160</span>
<span class=normal>161</span>
<span class=normal>162</span>
<span class=normal>163</span>
<span class=normal>164</span>
<span class=normal>165</span>
<span class=normal>166</span>
<span class=normal>167</span>
<span class=normal>168</span>
<span class=normal>169</span>
<span class=normal>170</span>
<span class=normal>171</span>
<span class=normal>172</span>
<span class=normal>173</span>
<span class=normal>174</span>
<span class=normal>175</span>
<span class=normal>176</span>
<span class=normal>177</span>
<span class=normal>178</span>
<span class=normal>179</span>
<span class=normal>180</span>
<span class=normal>181</span>
<span class=normal>182</span>
<span class=normal>183</span>
<span class=normal>184</span>
<span class=normal>185</span>
<span class=normal>186</span>
<span class=normal>187</span>
<span class=normal>188</span>
<span class=normal>189</span>
<span class=normal>190</span>
<span class=normal>191</span>
<span class=normal>192</span>
<span class=normal>193</span>
<span class=normal>194</span>
<span class=normal>195</span>
<span class=normal>196</span>
<span class=normal>197</span>
<span class=normal>198</span>
<span class=normal>199</span>
<span class=normal>200</span>
<span class=normal>201</span>
<span class=normal>202</span>
<span class=normal>203</span>
<span class=normal>204</span>
<span class=normal>205</span>
<span class=normal>206</span>
<span class=normal>207</span>
<span class=normal>208</span>
<span class=normal>209</span>
<span class=normal>210</span>
<span class=normal>211</span>
<span class=normal>212</span>
<span class=normal>213</span>
<span class=normal>214</span>
<span class=normal>215</span>
<span class=normal>216</span>
<span class=normal>217</span>
<span class=normal>218</span>
<span class=normal>219</span>
<span class=normal>220</span>
<span class=normal>221</span>
<span class=normal>222</span>
<span class=normal>223</span>
<span class=normal>224</span>
<span class=normal>225</span>
<span class=normal>226</span>
<span class=normal>227</span>
<span class=normal>228</span>
<span class=normal>229</span>
<span class=normal>230</span>
<span class=normal>231</span>
<span class=normal>232</span>
<span class=normal>233</span>
<span class=normal>234</span>
<span class=normal>235</span>
<span class=normal>236</span>
<span class=normal>237</span>
<span class=normal>238</span>
<span class=normal>239</span>
<span class=normal>240</span>
<span class=normal>241</span>
<span class=normal>242</span>
<span class=normal>243</span>
<span class=normal>244</span>
<span class=normal>245</span>
<span class=normal>246</span>
<span class=normal>247</span>
<span class=normal>248</span>
<span class=normal>249</span>
<span class=normal>250</span>
<span class=normal>251</span>
<span class=normal>252</span>
<span class=normal>253</span>
<span class=normal>254</span>
<span class=normal>255</span>
<span class=normal>256</span>
<span class=normal>257</span>
<span class=normal>258</span>
<span class=normal>259</span>
<span class=normal>260</span>
<span class=normal>261</span>
<span class=normal>262</span>
<span class=normal>263</span>
<span class=normal>264</span>
<span class=normal>265</span>
<span class=normal>266</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>class</span> <span class=nc>UpdateDeals</span><span class=p>:</span>
    <span class=k>def</span> <span class=nf>update_deals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>EDW_submissions</span><span class=p>,</span> <span class=n>new_clients</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;Downloads all deals from EDW within the /tmp_csv_files subfolder found in the DISC module.</span>
<span class=sd>        Creates/updates self._trackers.DISC_submissions csv file in /tracker subfolder accordingly.</span>
<span class=sd>        * User needs EDWIN account with the European Data Warehouse</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        EDW_submissions : Pandas dataFrame</span>
<span class=sd>            Containing metadata of deals within EDW&#39;s databas.</span>
<span class=sd>            Corresponding csv file can be found in /tracker subfolder within DISC</span>
<span class=sd>            module, if no files are present run EDW_submissions_tracker() first.</span>
<span class=sd>            See EDW_submissions_tracker() for more information</span>
<span class=sd>        new_clients : bool, optional</span>
<span class=sd>            Whether to create a fresh set of Deal- and PerformanceClient objects, by default True</span>

<span class=sd>        Raises</span>
<span class=sd>        ------</span>
<span class=sd>        AttributeError</span>
<span class=sd>            In case all of the EDW deals have already been downloaded</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1>## Define path</span>
        <span class=c1># -------------</span>
        <span class=n>path_root</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_path_root</span>
        <span class=n>path_destination</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>path_root</span><span class=p>,</span> <span class=s2>&quot;tmp_csv_files&quot;</span><span class=p>)</span>
        <span class=n>path_trackers</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>path_root</span><span class=p>,</span> <span class=s2>&quot;trackers&quot;</span><span class=p>)</span>

        <span class=c1>## Initialze clients</span>
        <span class=c1># --------------------------</span>
        <span class=k>if</span> <span class=n>new_clients</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>edw_DealClient_PerformanceClient_initializer</span><span class=p>()</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>dc</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_connections</span><span class=o>.</span><span class=n>clients</span><span class=o>.</span><span class=n>dc</span>
            <span class=n>pc</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_connections</span><span class=o>.</span><span class=n>clients</span><span class=o>.</span><span class=n>pc</span>

        <span class=c1>## Add decorator to pc.download_csv_file to ensure fallback when connection drops</span>
        <span class=c1># -----------------------------------------------------------------------</span>
        <span class=c1># whenever our external connection falls out with EDW, we&#39;ll wait</span>
        <span class=c1># for a while and try again (up to 10 times). Each time we wait an additional</span>
        <span class=c1># minute longer for the connection to restore again</span>
        <span class=n>pc</span><span class=o>.</span><span class=n>download_csv_file</span> <span class=o>=</span> <span class=n>retry</span><span class=p>(</span>
            <span class=n>wait</span><span class=o>=</span><span class=n>wait_incrementing</span><span class=p>(</span><span class=n>start</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>increment</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=nb>max</span><span class=o>=</span><span class=mi>100</span><span class=p>),</span>
            <span class=n>stop</span><span class=o>=</span><span class=n>stop_after_attempt</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span>
            <span class=n>retry</span><span class=o>=</span><span class=n>retry_if_exception_type</span><span class=p>(</span><span class=n>HTTPError</span><span class=p>)</span>
            <span class=o>|</span> <span class=n>retry_if_exception_type</span><span class=p>(</span><span class=ne>ConnectionError</span><span class=p>),</span>
        <span class=p>)(</span><span class=n>pc</span><span class=o>.</span><span class=n>download_csv_file</span><span class=p>)</span>

        <span class=c1>## Disc_submission</span>
        <span class=c1># ------------------</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span>
        <span class=p>):</span>  <span class=c1># if disc_submission isn&#39;t initialized as a dataFrame</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span>
                <span class=n>columns</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;edcode&quot;</span><span class=p>,</span> <span class=s2>&quot;PCD&quot;</span><span class=p>,</span> <span class=s2>&quot;requestid&quot;</span><span class=p>]</span>
            <span class=p>)</span>  <span class=c1># initialize new dataFrame</span>

        <span class=c1>## Determine which new submissions haven&#39;t been processed by the data production pipeline</span>
        <span class=c1># ----------------------------------------------------------------------------------------</span>
        <span class=c1># Determine the complement of self._trackers.DISC_submissions with elements present in EDW_submissions</span>
        <span class=c1># Thus we need -&gt; (~disc ⋂ edw)</span>
        <span class=c1># We condition on requestid as it is a unique identifier</span>
        <span class=c1># to_download returns elements of (disc ⋂ edw) as NaN so we drop them</span>
        <span class=c1># to_download keeps track of index that we don&#39;t need, so we reset the index</span>
        <span class=n>to_download</span> <span class=o>=</span> <span class=p>(</span>
            <span class=n>EDW_submissions</span><span class=p>[</span>
                <span class=o>~</span><span class=n>EDW_submissions</span><span class=o>.</span><span class=n>requestid</span><span class=o>.</span><span class=n>isin</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>requestid</span>
                <span class=p>)</span>
            <span class=p>]</span>
            <span class=o>.</span><span class=n>dropna</span><span class=p>(</span><span class=n>how</span><span class=o>=</span><span class=s2>&quot;all&quot;</span><span class=p>)</span>
            <span class=o>.</span><span class=n>reset_index</span><span class=p>(</span><span class=n>drop</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=c1># Check whether (~disc ⋂ edw) is non-empty</span>
        <span class=k>if</span> <span class=n>to_download</span><span class=o>.</span><span class=n>empty</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>AttributeError</span><span class=p>(</span>
                <span class=s2>&quot;All EDW submissions have already been downloaded before!&quot;</span>
            <span class=p>)</span>

        <span class=c1># Add columns to track Pipelines</span>
        <span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;local&quot;</span><span class=p>,</span> <span class=s2>&quot;processed&quot;</span><span class=p>,</span> <span class=s2>&quot;DISC&quot;</span><span class=p>,</span> <span class=s2>&quot;backup&quot;</span><span class=p>,</span> <span class=s2>&quot;parquet&quot;</span><span class=p>,</span> <span class=s2>&quot;csvFileName&quot;</span><span class=p>]</span>
        <span class=k>for</span> <span class=n>everyColumn</span> <span class=ow>in</span> <span class=n>columns</span><span class=p>:</span>
            <span class=n>to_download</span><span class=p>[</span><span class=n>everyColumn</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span>

        <span class=c1>## Download csv.gzip files from EDW&#39;s database to a local environment</span>
        <span class=c1># ------------------------------------------------------------------------</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&gt;&gt;&gt; Downloading new submissions...&quot;</span><span class=p>)</span>
        <span class=n>new</span> <span class=o>=</span> <span class=n>to_download</span><span class=p>[</span><span class=s2>&quot;PCD&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>str</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot; &quot;</span><span class=p>,</span> <span class=n>expand</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
        <span class=n>to_download</span><span class=p>[</span><span class=s2>&quot;PCD&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>new</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
        <span class=n>new</span> <span class=o>=</span> <span class=n>to_download</span><span class=p>[</span><span class=s2>&quot;PCD&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>str</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;-&quot;</span><span class=p>,</span> <span class=n>expand</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
        <span class=n>to_download</span><span class=p>[</span><span class=s2>&quot;year&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>new</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
        <span class=n>to_download</span><span class=p>[</span><span class=s2>&quot;month&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>new</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
        <span class=n>to_download</span><span class=p>[</span><span class=s2>&quot;day&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>new</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
        <span class=k>for</span> <span class=n>index</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>to_download</span><span class=o>.</span><span class=n>iterrows</span><span class=p>():</span>
            <span class=n>cutoff_date</span> <span class=o>=</span> <span class=n>dt</span><span class=o>.</span><span class=n>datetime</span><span class=p>(</span>
                <span class=n>year</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=s2>&quot;year&quot;</span><span class=p>]),</span> <span class=n>month</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=s2>&quot;month&quot;</span><span class=p>]),</span> <span class=n>day</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=s2>&quot;day&quot;</span><span class=p>])</span>
            <span class=p>)</span><span class=o>.</span><span class=n>date</span><span class=p>()</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=n>meta_data</span> <span class=o>=</span> <span class=n>pc</span><span class=o>.</span><span class=n>download_csv_file</span><span class=p>(</span>
                    <span class=n>ed_code</span><span class=o>=</span><span class=n>row</span><span class=p>[</span><span class=s2>&quot;edcode&quot;</span><span class=p>],</span>
                    <span class=n>data_section</span><span class=o>=</span><span class=s2>&quot;POOL&quot;</span><span class=p>,</span>
                    <span class=n>pool_cutoff_date</span><span class=o>=</span><span class=n>cutoff_date</span><span class=p>,</span>
                    <span class=n>destination</span><span class=o>=</span><span class=n>path_destination</span><span class=p>,</span>
                <span class=p>)</span>
                <span class=k>if</span> <span class=n>meta_data</span> <span class=o>!=</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=c1># fill in row</span>
                    <span class=n>row</span> <span class=o>=</span> <span class=n>row</span><span class=o>.</span><span class=n>drop</span><span class=p>([</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>])</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;local&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;TMP&quot;</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;processed&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;DISC&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;backup&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;parquet&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;csvFileName&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>meta_data</span><span class=p>[</span><span class=s2>&quot;CsvFileName&quot;</span><span class=p>]</span>
                    <span class=c1># add row to self._trackers.DISC_submissions</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>row</span><span class=p>)[</span>
                            <span class=n>to_download</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span>
                                <span class=p>[</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span>
                            <span class=p>)</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
                        <span class=p>]</span>
                    <span class=p>)</span>
                    <span class=c1># discard meta data</span>
                    <span class=n>meta_data</span> <span class=o>=</span> <span class=kc>None</span>
            <span class=k>except</span> <span class=n>EDWSOAPServiceError</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span>
                    <span class=s2>&quot;EDWSOAPServiceError has been raised, updating disc_submission tracker..&quot;</span>
                <span class=p>)</span>
                <span class=c1># fill in row</span>
                <span class=n>row</span> <span class=o>=</span> <span class=n>row</span><span class=o>.</span><span class=n>drop</span><span class=p>([</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>])</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;local&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;EDWSOAPServiceError&quot;</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;processed&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;DISC&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;backup&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;parquet&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;csvFileName&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NOT FOUND&quot;</span>
                <span class=c1># add row to self._trackers.DISC_submissions</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>row</span><span class=p>)[</span>
                        <span class=n>to_download</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span>
                            <span class=p>[</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span>
                        <span class=p>)</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
                    <span class=p>]</span>
                <span class=p>)</span>

            <span class=c1>## Generic exception catcher (in most cases ConnectionError when vpn/cnxn falls out)</span>
            <span class=c1># --------------------------------------------------------------------------------------</span>
            <span class=k>except</span><span class=p>:</span>
                <span class=c1># Save tracker up until this point</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>dropna</span><span class=p>(</span><span class=n>how</span><span class=o>=</span><span class=s2>&quot;all&quot;</span><span class=p>,</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span>
                    <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>path_trackers</span><span class=p>,</span> <span class=s2>&quot;disc_submissions_rmb.csv&quot;</span><span class=p>),</span>
                    <span class=n>header</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
                    <span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
                <span class=p>)</span>
                <span class=c1># Sleep for 10min and try again</span>
                <span class=n>sleep</span><span class=p>(</span><span class=mi>600</span><span class=p>)</span>

                <span class=c1>## try again</span>
                <span class=k>try</span><span class=p>:</span>
                    <span class=n>meta_data</span> <span class=o>=</span> <span class=n>pc</span><span class=o>.</span><span class=n>download_csv_file</span><span class=p>(</span>
                        <span class=n>ed_code</span><span class=o>=</span><span class=n>row</span><span class=p>[</span><span class=s2>&quot;edcode&quot;</span><span class=p>],</span>
                        <span class=n>data_section</span><span class=o>=</span><span class=s2>&quot;POOL&quot;</span><span class=p>,</span>
                        <span class=n>pool_cutoff_date</span><span class=o>=</span><span class=n>cutoff_date</span><span class=p>,</span>
                        <span class=n>destination</span><span class=o>=</span><span class=n>path_destination</span><span class=p>,</span>
                    <span class=p>)</span>
                    <span class=k>if</span> <span class=n>meta_data</span> <span class=o>!=</span> <span class=kc>None</span><span class=p>:</span>
                        <span class=c1># fill in row</span>
                        <span class=n>row</span> <span class=o>=</span> <span class=n>row</span><span class=o>.</span><span class=n>drop</span><span class=p>([</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>])</span>
                        <span class=n>row</span><span class=p>[</span><span class=s2>&quot;local&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;TMP&quot;</span>
                        <span class=n>row</span><span class=p>[</span><span class=s2>&quot;processed&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                        <span class=n>row</span><span class=p>[</span><span class=s2>&quot;DISC&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                        <span class=n>row</span><span class=p>[</span><span class=s2>&quot;backup&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                        <span class=n>row</span><span class=p>[</span><span class=s2>&quot;parquet&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                        <span class=n>row</span><span class=p>[</span><span class=s2>&quot;csvFileName&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>meta_data</span><span class=p>[</span><span class=s2>&quot;CsvFileName&quot;</span><span class=p>]</span>
                        <span class=c1># add row to self._trackers.DISC_submissions</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span> <span class=o>=</span> <span class=p>(</span>
                            <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>row</span><span class=p>)[</span>
                                <span class=n>to_download</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span>
                                    <span class=p>[</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span>
                                <span class=p>)</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
                            <span class=p>]</span>
                        <span class=p>)</span>
                        <span class=c1># discard meta data</span>
                        <span class=n>meta_data</span> <span class=o>=</span> <span class=kc>None</span>
                <span class=k>except</span> <span class=n>EDWSOAPServiceError</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span>
                        <span class=s2>&quot;EDWSOAPServiceError has been raised, updating disc_submission tracker..&quot;</span>
                    <span class=p>)</span>
                    <span class=c1># fill in row</span>
                    <span class=n>row</span> <span class=o>=</span> <span class=n>row</span><span class=o>.</span><span class=n>drop</span><span class=p>([</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>])</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;local&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;EDWSOAPServiceError&quot;</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;processed&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;DISC&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;backup&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;parquet&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;csvFileName&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NOT FOUND&quot;</span>
                    <span class=c1># add row to self._trackers.DISC_submissions</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>row</span><span class=p>)[</span>
                            <span class=n>to_download</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span>
                                <span class=p>[</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span>
                            <span class=p>)</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
                        <span class=p>]</span>
                    <span class=p>)</span>
                <span class=k>except</span><span class=p>:</span>
                    <span class=c1># Save tracker up until this point and stop running for now</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>dropna</span><span class=p>(</span><span class=n>how</span><span class=o>=</span><span class=s2>&quot;all&quot;</span><span class=p>,</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span>
                        <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>path_trackers</span><span class=p>,</span> <span class=s2>&quot;disc_submissions_rmb.csv&quot;</span><span class=p>),</span>
                        <span class=n>header</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
                        <span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
                    <span class=p>)</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;disc_submission tracker updated successfully!&quot;</span><span class=p>)</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;-------------------------------------------------&quot;</span><span class=p>)</span>
                    <span class=nb>print</span><span class=p>(</span>
                        <span class=s2>&quot;Uknown error has occured while running update_deals() to download new submissions. </span><span class=se>\n</span><span class=s2>&quot;</span>
                        <span class=s2>&quot;Please verify a stable network connection, and run the script again. </span><span class=se>\n</span><span class=s2>&quot;</span>
                        <span class=s2>&quot;The script will automatically continue from the last downloaded deal based on the saved tracker.&quot;</span>
                    <span class=p>)</span>

        <span class=c1>## Save updated disc_submission tracker</span>
        <span class=c1># -----------------------------------------</span>
        <span class=c1># nan rows occur for deals where all submissions have already been downloaded before</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>dropna</span><span class=p>(</span><span class=n>how</span><span class=o>=</span><span class=s2>&quot;all&quot;</span><span class=p>,</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span>
            <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>path_trackers</span><span class=p>,</span> <span class=s2>&quot;disc_submissions_rmb.csv&quot;</span><span class=p>),</span>
            <span class=n>header</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
            <span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&gt;&gt;&gt; Downloads complete &amp; disc_submission tracker updated successfully!&quot;</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> <div class="doc doc-children"> <div class="doc doc-object doc-function"> <h3 id=src.EDWtoDISC._UpdateDeals.UpdateDeals.update_deals class="doc doc-heading"> <code class="highlight language-python"><span class=n>update_deals</span><span class=p>(</span><span class=n>EDW_submissions</span><span class=p>,</span> <span class=n>new_clients</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span></code> <a href=#src.EDWtoDISC._UpdateDeals.UpdateDeals.update_deals class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Downloads all deals from EDW within the /tmp_csv_files subfolder found in the DISC module. Creates/updates self._trackers.DISC_submissions csv file in /tracker subfolder accordingly. * User needs EDWIN account with the European Data Warehouse</p> <p><strong>Parameters:</strong></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr> <td><code>EDW_submissions</code></td> <td> <code>Pandas dataFrame</code> </td> <td><p>Containing metadata of deals within EDW's databas. Corresponding csv file can be found in /tracker subfolder within DISC module, if no files are present run EDW_submissions_tracker() first. See EDW_submissions_tracker() for more information</p></td> <td> <em>required</em> </td> </tr> <tr> <td><code>new_clients</code></td> <td> <code>bool, optional</code> </td> <td><p>Whether to create a fresh set of Deal- and PerformanceClient objects, by default True</p></td> <td> <code>False</code> </td> </tr> </tbody> </table> <p><strong>Raises:</strong></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td> <code>AttributeError</code> </td> <td><p>In case all of the EDW deals have already been downloaded</p></td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src\EDWtoDISC\_UpdateDeals.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 39</span>
<span class=normal> 40</span>
<span class=normal> 41</span>
<span class=normal> 42</span>
<span class=normal> 43</span>
<span class=normal> 44</span>
<span class=normal> 45</span>
<span class=normal> 46</span>
<span class=normal> 47</span>
<span class=normal> 48</span>
<span class=normal> 49</span>
<span class=normal> 50</span>
<span class=normal> 51</span>
<span class=normal> 52</span>
<span class=normal> 53</span>
<span class=normal> 54</span>
<span class=normal> 55</span>
<span class=normal> 56</span>
<span class=normal> 57</span>
<span class=normal> 58</span>
<span class=normal> 59</span>
<span class=normal> 60</span>
<span class=normal> 61</span>
<span class=normal> 62</span>
<span class=normal> 63</span>
<span class=normal> 64</span>
<span class=normal> 65</span>
<span class=normal> 66</span>
<span class=normal> 67</span>
<span class=normal> 68</span>
<span class=normal> 69</span>
<span class=normal> 70</span>
<span class=normal> 71</span>
<span class=normal> 72</span>
<span class=normal> 73</span>
<span class=normal> 74</span>
<span class=normal> 75</span>
<span class=normal> 76</span>
<span class=normal> 77</span>
<span class=normal> 78</span>
<span class=normal> 79</span>
<span class=normal> 80</span>
<span class=normal> 81</span>
<span class=normal> 82</span>
<span class=normal> 83</span>
<span class=normal> 84</span>
<span class=normal> 85</span>
<span class=normal> 86</span>
<span class=normal> 87</span>
<span class=normal> 88</span>
<span class=normal> 89</span>
<span class=normal> 90</span>
<span class=normal> 91</span>
<span class=normal> 92</span>
<span class=normal> 93</span>
<span class=normal> 94</span>
<span class=normal> 95</span>
<span class=normal> 96</span>
<span class=normal> 97</span>
<span class=normal> 98</span>
<span class=normal> 99</span>
<span class=normal>100</span>
<span class=normal>101</span>
<span class=normal>102</span>
<span class=normal>103</span>
<span class=normal>104</span>
<span class=normal>105</span>
<span class=normal>106</span>
<span class=normal>107</span>
<span class=normal>108</span>
<span class=normal>109</span>
<span class=normal>110</span>
<span class=normal>111</span>
<span class=normal>112</span>
<span class=normal>113</span>
<span class=normal>114</span>
<span class=normal>115</span>
<span class=normal>116</span>
<span class=normal>117</span>
<span class=normal>118</span>
<span class=normal>119</span>
<span class=normal>120</span>
<span class=normal>121</span>
<span class=normal>122</span>
<span class=normal>123</span>
<span class=normal>124</span>
<span class=normal>125</span>
<span class=normal>126</span>
<span class=normal>127</span>
<span class=normal>128</span>
<span class=normal>129</span>
<span class=normal>130</span>
<span class=normal>131</span>
<span class=normal>132</span>
<span class=normal>133</span>
<span class=normal>134</span>
<span class=normal>135</span>
<span class=normal>136</span>
<span class=normal>137</span>
<span class=normal>138</span>
<span class=normal>139</span>
<span class=normal>140</span>
<span class=normal>141</span>
<span class=normal>142</span>
<span class=normal>143</span>
<span class=normal>144</span>
<span class=normal>145</span>
<span class=normal>146</span>
<span class=normal>147</span>
<span class=normal>148</span>
<span class=normal>149</span>
<span class=normal>150</span>
<span class=normal>151</span>
<span class=normal>152</span>
<span class=normal>153</span>
<span class=normal>154</span>
<span class=normal>155</span>
<span class=normal>156</span>
<span class=normal>157</span>
<span class=normal>158</span>
<span class=normal>159</span>
<span class=normal>160</span>
<span class=normal>161</span>
<span class=normal>162</span>
<span class=normal>163</span>
<span class=normal>164</span>
<span class=normal>165</span>
<span class=normal>166</span>
<span class=normal>167</span>
<span class=normal>168</span>
<span class=normal>169</span>
<span class=normal>170</span>
<span class=normal>171</span>
<span class=normal>172</span>
<span class=normal>173</span>
<span class=normal>174</span>
<span class=normal>175</span>
<span class=normal>176</span>
<span class=normal>177</span>
<span class=normal>178</span>
<span class=normal>179</span>
<span class=normal>180</span>
<span class=normal>181</span>
<span class=normal>182</span>
<span class=normal>183</span>
<span class=normal>184</span>
<span class=normal>185</span>
<span class=normal>186</span>
<span class=normal>187</span>
<span class=normal>188</span>
<span class=normal>189</span>
<span class=normal>190</span>
<span class=normal>191</span>
<span class=normal>192</span>
<span class=normal>193</span>
<span class=normal>194</span>
<span class=normal>195</span>
<span class=normal>196</span>
<span class=normal>197</span>
<span class=normal>198</span>
<span class=normal>199</span>
<span class=normal>200</span>
<span class=normal>201</span>
<span class=normal>202</span>
<span class=normal>203</span>
<span class=normal>204</span>
<span class=normal>205</span>
<span class=normal>206</span>
<span class=normal>207</span>
<span class=normal>208</span>
<span class=normal>209</span>
<span class=normal>210</span>
<span class=normal>211</span>
<span class=normal>212</span>
<span class=normal>213</span>
<span class=normal>214</span>
<span class=normal>215</span>
<span class=normal>216</span>
<span class=normal>217</span>
<span class=normal>218</span>
<span class=normal>219</span>
<span class=normal>220</span>
<span class=normal>221</span>
<span class=normal>222</span>
<span class=normal>223</span>
<span class=normal>224</span>
<span class=normal>225</span>
<span class=normal>226</span>
<span class=normal>227</span>
<span class=normal>228</span>
<span class=normal>229</span>
<span class=normal>230</span>
<span class=normal>231</span>
<span class=normal>232</span>
<span class=normal>233</span>
<span class=normal>234</span>
<span class=normal>235</span>
<span class=normal>236</span>
<span class=normal>237</span>
<span class=normal>238</span>
<span class=normal>239</span>
<span class=normal>240</span>
<span class=normal>241</span>
<span class=normal>242</span>
<span class=normal>243</span>
<span class=normal>244</span>
<span class=normal>245</span>
<span class=normal>246</span>
<span class=normal>247</span>
<span class=normal>248</span>
<span class=normal>249</span>
<span class=normal>250</span>
<span class=normal>251</span>
<span class=normal>252</span>
<span class=normal>253</span>
<span class=normal>254</span>
<span class=normal>255</span>
<span class=normal>256</span>
<span class=normal>257</span>
<span class=normal>258</span>
<span class=normal>259</span>
<span class=normal>260</span>
<span class=normal>261</span>
<span class=normal>262</span>
<span class=normal>263</span>
<span class=normal>264</span>
<span class=normal>265</span>
<span class=normal>266</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>update_deals</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>EDW_submissions</span><span class=p>,</span> <span class=n>new_clients</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;Downloads all deals from EDW within the /tmp_csv_files subfolder found in the DISC module.</span>
<span class=sd>    Creates/updates self._trackers.DISC_submissions csv file in /tracker subfolder accordingly.</span>
<span class=sd>    * User needs EDWIN account with the European Data Warehouse</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    EDW_submissions : Pandas dataFrame</span>
<span class=sd>        Containing metadata of deals within EDW&#39;s databas.</span>
<span class=sd>        Corresponding csv file can be found in /tracker subfolder within DISC</span>
<span class=sd>        module, if no files are present run EDW_submissions_tracker() first.</span>
<span class=sd>        See EDW_submissions_tracker() for more information</span>
<span class=sd>    new_clients : bool, optional</span>
<span class=sd>        Whether to create a fresh set of Deal- and PerformanceClient objects, by default True</span>

<span class=sd>    Raises</span>
<span class=sd>    ------</span>
<span class=sd>    AttributeError</span>
<span class=sd>        In case all of the EDW deals have already been downloaded</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=c1>## Define path</span>
    <span class=c1># -------------</span>
    <span class=n>path_root</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_path_root</span>
    <span class=n>path_destination</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>path_root</span><span class=p>,</span> <span class=s2>&quot;tmp_csv_files&quot;</span><span class=p>)</span>
    <span class=n>path_trackers</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>path_root</span><span class=p>,</span> <span class=s2>&quot;trackers&quot;</span><span class=p>)</span>

    <span class=c1>## Initialze clients</span>
    <span class=c1># --------------------------</span>
    <span class=k>if</span> <span class=n>new_clients</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>edw_DealClient_PerformanceClient_initializer</span><span class=p>()</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>dc</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_connections</span><span class=o>.</span><span class=n>clients</span><span class=o>.</span><span class=n>dc</span>
        <span class=n>pc</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_connections</span><span class=o>.</span><span class=n>clients</span><span class=o>.</span><span class=n>pc</span>

    <span class=c1>## Add decorator to pc.download_csv_file to ensure fallback when connection drops</span>
    <span class=c1># -----------------------------------------------------------------------</span>
    <span class=c1># whenever our external connection falls out with EDW, we&#39;ll wait</span>
    <span class=c1># for a while and try again (up to 10 times). Each time we wait an additional</span>
    <span class=c1># minute longer for the connection to restore again</span>
    <span class=n>pc</span><span class=o>.</span><span class=n>download_csv_file</span> <span class=o>=</span> <span class=n>retry</span><span class=p>(</span>
        <span class=n>wait</span><span class=o>=</span><span class=n>wait_incrementing</span><span class=p>(</span><span class=n>start</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>increment</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=nb>max</span><span class=o>=</span><span class=mi>100</span><span class=p>),</span>
        <span class=n>stop</span><span class=o>=</span><span class=n>stop_after_attempt</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span>
        <span class=n>retry</span><span class=o>=</span><span class=n>retry_if_exception_type</span><span class=p>(</span><span class=n>HTTPError</span><span class=p>)</span>
        <span class=o>|</span> <span class=n>retry_if_exception_type</span><span class=p>(</span><span class=ne>ConnectionError</span><span class=p>),</span>
    <span class=p>)(</span><span class=n>pc</span><span class=o>.</span><span class=n>download_csv_file</span><span class=p>)</span>

    <span class=c1>## Disc_submission</span>
    <span class=c1># ------------------</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span>
    <span class=p>):</span>  <span class=c1># if disc_submission isn&#39;t initialized as a dataFrame</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span>
            <span class=n>columns</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;edcode&quot;</span><span class=p>,</span> <span class=s2>&quot;PCD&quot;</span><span class=p>,</span> <span class=s2>&quot;requestid&quot;</span><span class=p>]</span>
        <span class=p>)</span>  <span class=c1># initialize new dataFrame</span>

    <span class=c1>## Determine which new submissions haven&#39;t been processed by the data production pipeline</span>
    <span class=c1># ----------------------------------------------------------------------------------------</span>
    <span class=c1># Determine the complement of self._trackers.DISC_submissions with elements present in EDW_submissions</span>
    <span class=c1># Thus we need -&gt; (~disc ⋂ edw)</span>
    <span class=c1># We condition on requestid as it is a unique identifier</span>
    <span class=c1># to_download returns elements of (disc ⋂ edw) as NaN so we drop them</span>
    <span class=c1># to_download keeps track of index that we don&#39;t need, so we reset the index</span>
    <span class=n>to_download</span> <span class=o>=</span> <span class=p>(</span>
        <span class=n>EDW_submissions</span><span class=p>[</span>
            <span class=o>~</span><span class=n>EDW_submissions</span><span class=o>.</span><span class=n>requestid</span><span class=o>.</span><span class=n>isin</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>requestid</span>
            <span class=p>)</span>
        <span class=p>]</span>
        <span class=o>.</span><span class=n>dropna</span><span class=p>(</span><span class=n>how</span><span class=o>=</span><span class=s2>&quot;all&quot;</span><span class=p>)</span>
        <span class=o>.</span><span class=n>reset_index</span><span class=p>(</span><span class=n>drop</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=p>)</span>
    <span class=c1># Check whether (~disc ⋂ edw) is non-empty</span>
    <span class=k>if</span> <span class=n>to_download</span><span class=o>.</span><span class=n>empty</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>AttributeError</span><span class=p>(</span>
            <span class=s2>&quot;All EDW submissions have already been downloaded before!&quot;</span>
        <span class=p>)</span>

    <span class=c1># Add columns to track Pipelines</span>
    <span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;local&quot;</span><span class=p>,</span> <span class=s2>&quot;processed&quot;</span><span class=p>,</span> <span class=s2>&quot;DISC&quot;</span><span class=p>,</span> <span class=s2>&quot;backup&quot;</span><span class=p>,</span> <span class=s2>&quot;parquet&quot;</span><span class=p>,</span> <span class=s2>&quot;csvFileName&quot;</span><span class=p>]</span>
    <span class=k>for</span> <span class=n>everyColumn</span> <span class=ow>in</span> <span class=n>columns</span><span class=p>:</span>
        <span class=n>to_download</span><span class=p>[</span><span class=n>everyColumn</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span>

    <span class=c1>## Download csv.gzip files from EDW&#39;s database to a local environment</span>
    <span class=c1># ------------------------------------------------------------------------</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&gt;&gt;&gt; Downloading new submissions...&quot;</span><span class=p>)</span>
    <span class=n>new</span> <span class=o>=</span> <span class=n>to_download</span><span class=p>[</span><span class=s2>&quot;PCD&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>str</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot; &quot;</span><span class=p>,</span> <span class=n>expand</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>to_download</span><span class=p>[</span><span class=s2>&quot;PCD&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>new</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
    <span class=n>new</span> <span class=o>=</span> <span class=n>to_download</span><span class=p>[</span><span class=s2>&quot;PCD&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>str</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;-&quot;</span><span class=p>,</span> <span class=n>expand</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>to_download</span><span class=p>[</span><span class=s2>&quot;year&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>new</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
    <span class=n>to_download</span><span class=p>[</span><span class=s2>&quot;month&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>new</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
    <span class=n>to_download</span><span class=p>[</span><span class=s2>&quot;day&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>new</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
    <span class=k>for</span> <span class=n>index</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>to_download</span><span class=o>.</span><span class=n>iterrows</span><span class=p>():</span>
        <span class=n>cutoff_date</span> <span class=o>=</span> <span class=n>dt</span><span class=o>.</span><span class=n>datetime</span><span class=p>(</span>
            <span class=n>year</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=s2>&quot;year&quot;</span><span class=p>]),</span> <span class=n>month</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=s2>&quot;month&quot;</span><span class=p>]),</span> <span class=n>day</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=s2>&quot;day&quot;</span><span class=p>])</span>
        <span class=p>)</span><span class=o>.</span><span class=n>date</span><span class=p>()</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>meta_data</span> <span class=o>=</span> <span class=n>pc</span><span class=o>.</span><span class=n>download_csv_file</span><span class=p>(</span>
                <span class=n>ed_code</span><span class=o>=</span><span class=n>row</span><span class=p>[</span><span class=s2>&quot;edcode&quot;</span><span class=p>],</span>
                <span class=n>data_section</span><span class=o>=</span><span class=s2>&quot;POOL&quot;</span><span class=p>,</span>
                <span class=n>pool_cutoff_date</span><span class=o>=</span><span class=n>cutoff_date</span><span class=p>,</span>
                <span class=n>destination</span><span class=o>=</span><span class=n>path_destination</span><span class=p>,</span>
            <span class=p>)</span>
            <span class=k>if</span> <span class=n>meta_data</span> <span class=o>!=</span> <span class=kc>None</span><span class=p>:</span>
                <span class=c1># fill in row</span>
                <span class=n>row</span> <span class=o>=</span> <span class=n>row</span><span class=o>.</span><span class=n>drop</span><span class=p>([</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>])</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;local&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;TMP&quot;</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;processed&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;DISC&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;backup&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;parquet&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;csvFileName&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>meta_data</span><span class=p>[</span><span class=s2>&quot;CsvFileName&quot;</span><span class=p>]</span>
                <span class=c1># add row to self._trackers.DISC_submissions</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>row</span><span class=p>)[</span>
                        <span class=n>to_download</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span>
                            <span class=p>[</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span>
                        <span class=p>)</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
                    <span class=p>]</span>
                <span class=p>)</span>
                <span class=c1># discard meta data</span>
                <span class=n>meta_data</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=k>except</span> <span class=n>EDWSOAPServiceError</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span>
                <span class=s2>&quot;EDWSOAPServiceError has been raised, updating disc_submission tracker..&quot;</span>
            <span class=p>)</span>
            <span class=c1># fill in row</span>
            <span class=n>row</span> <span class=o>=</span> <span class=n>row</span><span class=o>.</span><span class=n>drop</span><span class=p>([</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>])</span>
            <span class=n>row</span><span class=p>[</span><span class=s2>&quot;local&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;EDWSOAPServiceError&quot;</span>
            <span class=n>row</span><span class=p>[</span><span class=s2>&quot;processed&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
            <span class=n>row</span><span class=p>[</span><span class=s2>&quot;DISC&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
            <span class=n>row</span><span class=p>[</span><span class=s2>&quot;backup&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
            <span class=n>row</span><span class=p>[</span><span class=s2>&quot;parquet&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
            <span class=n>row</span><span class=p>[</span><span class=s2>&quot;csvFileName&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NOT FOUND&quot;</span>
            <span class=c1># add row to self._trackers.DISC_submissions</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span> <span class=o>=</span> <span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>row</span><span class=p>)[</span>
                    <span class=n>to_download</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span>
                        <span class=p>[</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
                <span class=p>]</span>
            <span class=p>)</span>

        <span class=c1>## Generic exception catcher (in most cases ConnectionError when vpn/cnxn falls out)</span>
        <span class=c1># --------------------------------------------------------------------------------------</span>
        <span class=k>except</span><span class=p>:</span>
            <span class=c1># Save tracker up until this point</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>dropna</span><span class=p>(</span><span class=n>how</span><span class=o>=</span><span class=s2>&quot;all&quot;</span><span class=p>,</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span>
                <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>path_trackers</span><span class=p>,</span> <span class=s2>&quot;disc_submissions_rmb.csv&quot;</span><span class=p>),</span>
                <span class=n>header</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
                <span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
            <span class=p>)</span>
            <span class=c1># Sleep for 10min and try again</span>
            <span class=n>sleep</span><span class=p>(</span><span class=mi>600</span><span class=p>)</span>

            <span class=c1>## try again</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=n>meta_data</span> <span class=o>=</span> <span class=n>pc</span><span class=o>.</span><span class=n>download_csv_file</span><span class=p>(</span>
                    <span class=n>ed_code</span><span class=o>=</span><span class=n>row</span><span class=p>[</span><span class=s2>&quot;edcode&quot;</span><span class=p>],</span>
                    <span class=n>data_section</span><span class=o>=</span><span class=s2>&quot;POOL&quot;</span><span class=p>,</span>
                    <span class=n>pool_cutoff_date</span><span class=o>=</span><span class=n>cutoff_date</span><span class=p>,</span>
                    <span class=n>destination</span><span class=o>=</span><span class=n>path_destination</span><span class=p>,</span>
                <span class=p>)</span>
                <span class=k>if</span> <span class=n>meta_data</span> <span class=o>!=</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=c1># fill in row</span>
                    <span class=n>row</span> <span class=o>=</span> <span class=n>row</span><span class=o>.</span><span class=n>drop</span><span class=p>([</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>])</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;local&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;TMP&quot;</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;processed&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;DISC&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;backup&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;parquet&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                    <span class=n>row</span><span class=p>[</span><span class=s2>&quot;csvFileName&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>meta_data</span><span class=p>[</span><span class=s2>&quot;CsvFileName&quot;</span><span class=p>]</span>
                    <span class=c1># add row to self._trackers.DISC_submissions</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>row</span><span class=p>)[</span>
                            <span class=n>to_download</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span>
                                <span class=p>[</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span>
                            <span class=p>)</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
                        <span class=p>]</span>
                    <span class=p>)</span>
                    <span class=c1># discard meta data</span>
                    <span class=n>meta_data</span> <span class=o>=</span> <span class=kc>None</span>
            <span class=k>except</span> <span class=n>EDWSOAPServiceError</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span>
                    <span class=s2>&quot;EDWSOAPServiceError has been raised, updating disc_submission tracker..&quot;</span>
                <span class=p>)</span>
                <span class=c1># fill in row</span>
                <span class=n>row</span> <span class=o>=</span> <span class=n>row</span><span class=o>.</span><span class=n>drop</span><span class=p>([</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>])</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;local&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;EDWSOAPServiceError&quot;</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;processed&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;DISC&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;backup&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;parquet&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NO&quot;</span>
                <span class=n>row</span><span class=p>[</span><span class=s2>&quot;csvFileName&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;NOT FOUND&quot;</span>
                <span class=c1># add row to self._trackers.DISC_submissions</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>row</span><span class=p>)[</span>
                        <span class=n>to_download</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span>
                            <span class=p>[</span><span class=s2>&quot;year&quot;</span><span class=p>,</span> <span class=s2>&quot;month&quot;</span><span class=p>,</span> <span class=s2>&quot;day&quot;</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span>
                        <span class=p>)</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
                    <span class=p>]</span>
                <span class=p>)</span>
            <span class=k>except</span><span class=p>:</span>
                <span class=c1># Save tracker up until this point and stop running for now</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>dropna</span><span class=p>(</span><span class=n>how</span><span class=o>=</span><span class=s2>&quot;all&quot;</span><span class=p>,</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span>
                    <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>path_trackers</span><span class=p>,</span> <span class=s2>&quot;disc_submissions_rmb.csv&quot;</span><span class=p>),</span>
                    <span class=n>header</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
                    <span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
                <span class=p>)</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;disc_submission tracker updated successfully!&quot;</span><span class=p>)</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;-------------------------------------------------&quot;</span><span class=p>)</span>
                <span class=nb>print</span><span class=p>(</span>
                    <span class=s2>&quot;Uknown error has occured while running update_deals() to download new submissions. </span><span class=se>\n</span><span class=s2>&quot;</span>
                    <span class=s2>&quot;Please verify a stable network connection, and run the script again. </span><span class=se>\n</span><span class=s2>&quot;</span>
                    <span class=s2>&quot;The script will automatically continue from the last downloaded deal based on the saved tracker.&quot;</span>
                <span class=p>)</span>

    <span class=c1>## Save updated disc_submission tracker</span>
    <span class=c1># -----------------------------------------</span>
    <span class=c1># nan rows occur for deals where all submissions have already been downloaded before</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>dropna</span><span class=p>(</span><span class=n>how</span><span class=o>=</span><span class=s2>&quot;all&quot;</span><span class=p>,</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_trackers</span><span class=o>.</span><span class=n>DISC_submissions</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span>
        <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>path_trackers</span><span class=p>,</span> <span class=s2>&quot;disc_submissions_rmb.csv&quot;</span><span class=p>),</span>
        <span class=n>header</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
        <span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
    <span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&gt;&gt;&gt; Downloads complete &amp; disc_submission tracker updated successfully!&quot;</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> </div> </div> </div> </div> </div> </div> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../ToNameSpace/ class="md-footer__link md-footer__link--prev" aria-label="Previous: ToNameSpace" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> ToNameSpace </div> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2020 - 2021 Ilias Aarab </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["content.tabs.link", "navigation.sections", "navigation.tabs", "navigation.tracking", "search.highlight", "search.share", "search.suggest"], "search": "../../assets/javascripts/workers/search.00c949be.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.82b56eb2.min.js></script> </body> </html>